name: RDP

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *"

jobs:
  rdp-server:
    runs-on: windows-latest
    timeout-minutes: 350

    steps:
      - name: Descargar Tailscale
        run: |
          Invoke-WebRequest -Uri "https://pkgs.tailscale.com/stable/tailscale-setup-latest.exe" -OutFile "tailscale.exe"

      - name: Instalar Tailscale
        run: |
          Start-Process ".\tailscale.exe" -ArgumentList "/quiet" -Wait

      - name: Iniciar Tailscale con hostname fijo
        env:
          TS_KEY: ${{ secrets.TS_KEY }}
        run: |
          & "C:\Program Files\Tailscale\tailscale.exe" up `
            --authkey=$env:TS_KEY `
            --hostname=github-rdp `
            --accept-routes `
            --ssh

      - name: Habilitar Remote Desktop (RDP)
        run: |
          Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server" `
                           -Name "fDenyTSConnections" -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"

      - name: Mantener sesi√≥n activa
        run: |
          while ($true) {
            Start-Sleep -Seconds 60
          }
